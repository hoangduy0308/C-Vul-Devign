name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production
  push:
    tags:
      - "v*"

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/devign-sliceattbigru

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:latest || echo "Image not found, will build"

      - name: Deploy to server via SSH
        if: ${{ secrets.DEPLOY_HOST != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            docker login ghcr.io -u ${{ github.actor }} --password-stdin <<< "${{ secrets.GITHUB_TOKEN }}"
            docker pull ${{ env.IMAGE_NAME }}:latest
            docker stop devign-api || true
            docker rm devign-api || true
            docker run -d \
              --name devign-api \
              --restart unless-stopped \
              -p 8000:8000 \
              ${{ env.IMAGE_NAME }}:latest
            docker system prune -f

      - name: Deploy notification
        run: |
          echo "ðŸš€ Deployment completed!"
          echo "Image: ${{ env.IMAGE_NAME }}:latest"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
